version: "3.1"
services:
    dcm-to-png:
        container_name: dcm-to-png
        image: dcm-to-png
        build:
            context: ./dcm-to-png
    devbox:
        image: healthsamurai/devbox:edge
        depends_on:
            - "devbox-db"
        links:
            - "devbox-db:database"
        ports:
            - "8080:8080"
        env_file:
            - .env.app
        environment:
            PGHOST: database
    devbox-db:
        image: "healthsamurai/aidboxdb:13.2"
        environment:
            POSTGRES_USER: "postgres"
            POSTGRES_PASSWORD: "postgres"
            POSTGRES_DB: "devbox"
    app:
        build: .
        volumes:
            - .:/usr/src/app
            - ./node_modules:/usr/src/app/node_modules
        container_name: app
        restart: always
        env_file:
            - .env.app
    sdc:
        image: bedasoftware/aidbox-sdc:latest
        command:
            [
                "pipenv",
                "run",
                "gunicorn",
                "main:create_app",
                "--worker-class",
                "aiohttp.worker.GunicornWebWorker",
                "-b",
                "0.0.0.0:8081",
                "--reload",
            ]
        depends_on:
            - devbox
        links:
            - devbox
        env_file:
            - .env.sdc
        # Colored logs
        tty: true
